<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anki Highlighter - Unified Test Suite</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .test-section {
        margin: 30px 0;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
      }

      .test-section h3 {
        margin-top: 0;
        color: #555;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }

      .test-text {
        font-size: 18px;
        line-height: 2;
        padding: 15px;
        background: white;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 4px solid #4caf50;
      }

      .instructions {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
      }

      .debug-panel {
        background: #fff3cd;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ffeaa7;
      }

      .debug-panel h4 {
        margin-top: 0;
        font-family: inherit;
        color: #856404;
      }

      .log-entry {
        margin: 5px 0;
        padding: 3px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .log-success {
        color: #28a745;
      }
      .log-error {
        color: #dc3545;
      }
      .log-warning {
        color: #ffc107;
      }
      .log-info {
        color: #17a2b8;
      }

      .stats-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #4caf50;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-top: 5px;
      }

      .controls {
        margin: 20px 0;
        text-align: center;
      }

      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }

      button:hover {
        background: #45a049;
      }

      button.secondary {
        background: #2196f3;
      }

      button.secondary:hover {
        background: #1976d2;
      }

      .color-test {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        border-radius: 3px;
        font-weight: 500;
      }

      .frequency-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
        padding: 15px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🧪 Anki Highlighter - Unified Test Suite</h1>

      <div class="instructions">
        <h3>🚀 Quick Start Guide</h3>
        <ol>
          <li>
            <strong>Load Extension:</strong> Make sure the extension is loaded
            from the `dist/` directory
          </li>
          <li>
            <strong>Check AnkiConnect:</strong> Ensure Anki is running with
            AnkiConnect addon
          </li>
          <li>
            <strong>Open Console:</strong> Press F12 to see detailed debug logs
          </li>
          <li>
            <strong>Test Features:</strong> Use the buttons below to test
            different aspects
          </li>
          <li>
            <strong>Check Results:</strong> Look for highlighting, tooltips, and
            stats overlay
          </li>
        </ol>
      </div>

      <div class="controls">
        <button id="runFullTestBtn">🔍 Run Full Test</button>
        <button id="testExtensionContextBtn" class="secondary">
          🔗 Test Extension Context
        </button>
        <button id="testAnkiConnectBtn" class="secondary">
          📚 Test AnkiConnect
        </button>
        <button id="clearLogsBtn">🗑️ Clear Logs</button>
        <button id="exportLogsBtn">📄 Export Logs</button>
      </div>

      <div class="stats-display">
        <div class="stat-card">
          <div class="stat-value" id="totalWords">-</div>
          <div class="stat-label">Total Words</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="highlightedWords">-</div>
          <div class="stat-label">Highlighted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="knowledgePercent">-</div>
          <div class="stat-label">Knowledge %</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="extensionStatus">-</div>
          <div class="stat-label">Extension Status</div>
        </div>
      </div>

      <div class="debug-panel">
        <h4>📋 Debug Logs</h4>
        <div id="debugLogs">
          <div class="log-entry log-info">
            Test page loaded. Waiting for extension...
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="test-section">
        <h3>🟢 Basic Japanese Text (Very Common Words)</h3>
        <div class="test-text">
          私 は 学生 です。今日 は 良い 天気 です。これ は とても 簡単 な 文章
          です。
        </div>
        <div class="test-text">
          あの 人 は 先生 です。本 を 読んで います。水 を 飲みます。
        </div>
      </div>

      <div class="test-section">
        <h3>🟡 Common Words (Should be Yellow-Green)</h3>
        <div class="test-text">
          漫画 を 読む の が 好き です。映画 も 面白い です。音楽 を 聞く こと
          も あります。
        </div>
        <div class="test-text">
          友達 と 一緒に 買い物 に 行きました。新しい 服 を 買いました。
        </div>
      </div>

      <div class="test-section">
        <h3>🟠 Less Common Words (Should be Orange)</h3>
        <div class="test-text">
          会社 で 働いて います。会議 が 多くて 忙しい です。プロジェクト の
          進捗 を 確認 します。
        </div>
        <div class="test-text">
          コンピューター を 使って プログラム を 作ります。データベース を 管理
          します。
        </div>
      </div>

      <div class="test-section">
        <h3>🔴 Rare Words (Should be Red)</h3>
        <div class="test-text">
          大学 で 経済学 を 勉強 して います。研究 は 困難 です が、やりがい が
          あります。
        </div>
        <div class="test-text">
          統計学 も 重要 です。データ分析 の 手法 を 学んで います。
        </div>
      </div>

      <div class="test-section">
        <h3>⚫ Mixed Content Test</h3>
        <div class="test-text">
          Hello world! 日本語 を 勉強 して います。Good luck with your studies!
        </div>
        <div class="test-text">
          桜 の 花 が 咲いて いる 公園 を 散歩 しました。春 の 風 が
          心地よかった です。
        </div>
        <div class="test-text">
          新しい 季節 の 始まり を 感じます。自然 の 美しさ に 感動 しました。
        </div>
      </div>

      <div class="test-section">
        <h3>🎨 Color Intensity Test</h3>
        <p>
          These words should show different color intensities based on your
          settings:
        </p>
        <div class="frequency-legend">
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: hsl(120, 40%, 85%); opacity: 0.3"
            ></div>
            <span>Very Common (1-100)</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: hsl(90, 40%, 85%); opacity: 0.5"
            ></div>
            <span>Common (101-500)</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: hsl(60, 40%, 85%); opacity: 0.7"
            ></div>
            <span>Uncommon (501-2k)</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: hsl(30, 40%, 85%); opacity: 0.9"
            ></div>
            <span>Rare (2k-10k)</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: hsl(0, 40%, 85%); opacity: 1"
            ></div>
            <span>Very Rare (10k+)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ccc"></div>
            <span>Not Found</span>
          </div>
        </div>
        <div class="test-text">
          私 学生 漫画 会社 経済学 統計学 データベース プログラム コンピューター
        </div>
      </div>

      <div class="test-section">
        <h3>🔄 Dynamic Content Test</h3>
        <div id="dynamicContent">
          <p>Click the button to add new Japanese content dynamically:</p>
        </div>
        <button id="addDynamicContentBtn">Add Dynamic Content</button>
      </div>
    </div>

    <script>
      let testLogs = [];
      let testStartTime = Date.now();

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = {
          timestamp,
          message,
          type,
          time: Date.now() - testStartTime,
        };
        testLogs.push(logEntry);

        const logsContainer = document.getElementById("debugLogs");
        const logElement = document.createElement("div");
        logElement.className = `log-entry log-${type}`;
        logElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        logsContainer.appendChild(logElement);
        logsContainer.scrollTop = logsContainer.scrollHeight;

        console.log(`[Anki Test] ${message}`);
      }

      function clearLogs() {
        testLogs = [];
        document.getElementById("debugLogs").innerHTML =
          '<div class="log-entry log-info">Logs cleared. Ready for new test...</div>';
      }

      function exportLogs() {
        const logText = testLogs
          .map(
            (log) =>
              `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`
          )
          .join("\n");

        const blob = new Blob([logText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `anki-highlighter-test-${Date.now()}.log`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function updateStats() {
        const highlightedElements = document.querySelectorAll(".anki-unknown");
        const totalJapaneseText = document.body.textContent.match(
          /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g
        );
        const totalWords = totalJapaneseText ? totalJapaneseText.length : 0;
        const highlightedCount = highlightedElements.length;
        const knowledgePercent =
          totalWords > 0
            ? Math.round(((totalWords - highlightedCount) / totalWords) * 100)
            : 0;

        document.getElementById("totalWords").textContent = totalWords;
        document.getElementById("highlightedWords").textContent =
          highlightedCount;
        document.getElementById("knowledgePercent").textContent =
          knowledgePercent + "%";

        // Test extension context
        try {
          chrome.runtime.getURL("");
          document.getElementById("extensionStatus").textContent = "✅ Active";
          document.getElementById("extensionStatus").style.color = "#28a745";
        } catch (error) {
          document.getElementById("extensionStatus").textContent = "❌ Invalid";
          document.getElementById("extensionStatus").style.color = "#dc3545";
        }

        log(
          `Stats updated: ${totalWords} total, ${highlightedCount} highlighted, ${knowledgePercent}% knowledge`
        );
      }

      function testExtensionContext() {
        try {
          const manifestUrl = chrome.runtime.getURL("manifest.json");
          log(
            `✅ Extension context valid. Manifest URL: ${manifestUrl}`,
            "success"
          );

          // Test message passing
          chrome.runtime.sendMessage({ type: "TEST" }, (response) => {
            if (chrome.runtime.lastError) {
              log(
                `❌ Message passing failed: ${chrome.runtime.lastError.message}`,
                "error"
              );
            } else {
              log("✅ Message passing working", "success");
            }
          });
        } catch (error) {
          log(`❌ Extension context invalid: ${error.message}`, "error");
        }
      }

      function testAnkiConnect() {
        log("🔍 Testing AnkiConnect connection...");

        fetch("http://127.0.0.1:8765", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "version", version: 6 }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              log(`❌ AnkiConnect error: ${data.error}`, "error");
            } else {
              log(`✅ AnkiConnect working! Version: ${data.result}`, "success");
            }
          })
          .catch((error) => {
            log(`❌ AnkiConnect connection failed: ${error.message}`, "error");
          });
      }

      function addDynamicContent() {
        const dynamicContainer = document.getElementById("dynamicContent");
        const newContent = document.createElement("div");
        newContent.className = "test-text";
        newContent.innerHTML = `
          <strong>Dynamic Content ${Date.now()}:</strong><br />
          新しい 動的 コンテンツ です。リアルタイム で 追加 されました。
        `;
        dynamicContainer.appendChild(newContent);
        log("➕ Added dynamic Japanese content", "info");

        // Update stats after a brief delay to allow extension to process
        setTimeout(updateStats, 1000);
      }

      function runFullTest() {
        log("🚀 Starting full test suite...", "info");
        clearLogs();

        // Test 1: Extension context
        setTimeout(() => {
          testExtensionContext();
        }, 500);

        // Test 2: AnkiConnect
        setTimeout(() => {
          testAnkiConnect();
        }, 1000);

        // Test 3: Check for highlighting
        setTimeout(() => {
          const highlighted = document.querySelectorAll(".anki-unknown");
          if (highlighted.length > 0) {
            log(`✅ Found ${highlighted.length} highlighted words`, "success");

            // Test color analysis
            highlighted.forEach((element, index) => {
              if (index < 5) {
                // Only log first 5
                const styles = window.getComputedStyle(element);
                const word = element.textContent;
                const bgColor = styles.backgroundColor;
                const color = styles.color;
                log(`🎨 "${word}": bg=${bgColor}, color=${color}`, "info");
              }
            });
          } else {
            log("❌ No highlighted words found", "error");
            log(
              "Possible issues: Extension not loaded, AnkiConnect not running, or all words are known",
              "warning"
            );
          }

          updateStats();
        }, 3000);

        // Test 4: Stats overlay
        setTimeout(() => {
          const statsOverlay = document.querySelector(".anki-stats");
          if (statsOverlay) {
            log("✅ Stats overlay found and visible", "success");
          } else {
            log("❌ Stats overlay not found", "error");
          }
        }, 4000);

        // Test 5: Settings test
        setTimeout(() => {
          chrome.storage.sync.get(
            ["colorIntensity", "showTooltips", "showStats"],
            (result) => {
              log(
                `⚙️ Current settings: intensity=${result.colorIntensity}, tooltips=${result.showTooltips}, stats=${result.showStats}`,
                "info"
              );
            }
          );
        }, 5000);

        log("✅ Full test suite completed", "success");
      }

      // Initialize page
      log("🧪 Unified test page loaded");
      log("Extension should initialize within 3 seconds...");

      // Auto-run basic checks
      setTimeout(() => {
        updateStats();
        testExtensionContext();
      }, 2000);

      // Periodic stats update
      setInterval(updateStats, 10000);

      // Add event listeners after DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        // Button event listeners
        document
          .getElementById("runFullTestBtn")
          .addEventListener("click", runFullTest);
        document
          .getElementById("testExtensionContextBtn")
          .addEventListener("click", testExtensionContext);
        document
          .getElementById("testAnkiConnectBtn")
          .addEventListener("click", testAnkiConnect);
        document
          .getElementById("clearLogsBtn")
          .addEventListener("click", clearLogs);
        document
          .getElementById("exportLogsBtn")
          .addEventListener("click", exportLogs);
        document
          .getElementById("addDynamicContentBtn")
          .addEventListener("click", addDynamicContent);
      });
    </script>
  </body>
</html>
